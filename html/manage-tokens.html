<html>
    <head>
        <title>Wombat dressing room</title>
        <link rel="stylesheet" href="/app.css" />
        <link rel="stylesheet" href="/github-markdown.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <div id="error"></div>
        <article class="markdown-body">
            <a href="/" alt="return to home">Home</a>
            <div id="message">You're logged in as {username}. <a id="logout-link" href="javascript:void(0);">logout</a></div>

            <h2>manage tokens</h2>
            <div>
                <h3>Create token for package.</h3>
                <form name="create-token" action="#">
                    <div>
                        <label>Package Name</label><br/>
                        <textarea name="package-name" value="" placeholder="package name or one package name per line"></textarea><br/>
                    </div>
                    <input type="submit" value="create token."/>
                    <div class="loading" style="display:none;">creating...</div>
                </form>
                <div id="created-tokens-display" style="display:none;">
                    <h4>created tokens:</h4>
                    <div>NOTICE: these tokens will never be shown again.<br/>creating multiple tokens without refreshing the page will keep adding them to this section to copy easily.</div>
                    <a href='javascript:window.location.reload()'>Clear all</a><br/>
                    <ul id="created-list"></ul>
                </div>
            </div>
            <div id="tokens-list">
                loading...
            </div>
        </article>
        <script src="/app.js"></script>
        <script>
        let state = {}

        let loop = async ()=>{
            // init handlers
            tokenForm()
            tokenList()

            let result = await api.tokens()
            console.log(result)
            if(result.error){
                state.error = result.error
            }
            state.tokens = result.data
            
            render()
        }

        function render(){
            renderCreatedTokens()
            renderTokens()
            renderError()
        }

        function tokenForm(){
            if(!state.tokenForm){
                state.tokenForm = {}
            } else {
                // only run these bindings once.
                return;
            }

            let tokenForm = document.querySelectorAll("form[name=create-token]")[0]
            tokenForm.addEventListener('submit',async (ev)=>{
                ev.stopPropagation()
                ev.preventDefault()
                if(tokenForm.submitting){
                    return;
                }

                let packageNameInput = tokenForm.querySelector('*[name=package-name]')
                let packageName = packageNameInput.value
                console.log('packageName: ',packageName)
                if(!packageName.trim().length){
                    alert('package name required.')
                    return;
                }

                let loading = tokenForm.querySelector('.loading')
                loading.setAttribute('style',"display:block;")
                state.tokenForm.submitting = true;
                
                try{
                    //token,package
                    let result = await api.tokenCreate(packageName)
                    console.log('token create result',result)

                    if(result.error){
                        alert(result.error);
                    }

                    if(! state.tokenForm.createdTokens){
                        state.tokenForm.createdTokens = []
                    }

                    

                    [].push.apply(state.tokenForm.createdTokens,result.data)
                    
                } catch(e){
                    console.log(e+e.stack)
                    alert('an error occurred.')
                }

                state.tokenForm.submitting = false;
                loading.setAttribute('style',"display:none;")
                if(packageNameInput.value == packageName){
                    packageNameInput.value = ''
                }

                // re-apply state
                loop()
            })
        }

        function tokenList(){
            if(tokenList.bound) return;
            tokenList.bound = true

            document.getElementById('tokens-list').addEventListener('click',async (ev)=>{
                let clicked = ev.target

                let classText = clicked.getAttribute('class')
                if(classText && classText.indexOf('token-delete') > -1){
                    ev.preventDefault()
                    ev.stopPropagation()

                    if(clicked.getAttribute('data-submitting')){
                        return;
                    }

                    let href = clicked.getAttribute('href').substr(1)
                    console.log('href value ',href)
                    const params = qs(href)

                    console.log(params)

                    if(!confirm('are you sure you wan to delete the token starting with '+params.prefix)){
                        return;
                    }

                    clicked.setAttribute('data-submitting',1)
                    let result = await api.tokenDelete(params)
                    if(result.error){
                        return alert(result.error)
                    }

                    // reload state.
                    loop()

                }

            })
        }

        function renderTokens() {
            if(!state.tokens) return;

            let tokensList = document.getElementById('tokens-list')
            if(state.tokens.error){
                tokensList.innerHTML = "error loading tokens. please <a href='javascript:window.location.reload()'>refresh</a> to try again."
                return;
            }

            let output = `<table>
                <tr>
                    <th>key</th><th>package</th><th>created</th><th>expires</th><th>actions</th>
                </tr>
            `
            state.tokens.forEach((tokenInfo) => {
                output += `<tr>
                    <td>${tokenInfo.prefix}...</td>
                    <td>${tokenInfo.package||'all packages'}</td>
                    <td>${new Date(tokenInfo.created).toJSON()}</td>
                    <td>${tokenInfo.expiration?new Date(tokenInfo.expiration).toJSON():'<span style="color:#999;">never</span>'}</td>
                    <td><a class="token-delete" href="#created=${tokenInfo.created}&prefix=${tokenInfo.prefix}">delete</a></td>
                </tr>
                `
            });
            
            output += "</table>"
            tokensList.innerHTML = output
        }

        function renderError(){
            if(!state.error){
                return;
            }

            let errorDisplay = document.getElementById('error')
            if(errorDisplay){
                errorDisplay.innerText = state.error
            }
        }

        function renderCreatedTokens(){
            if(!state.tokenForm || !state.tokenForm.createdTokens){
                return;
            }

            let display = document.getElementById("created-tokens-display")
            display.setAttribute('style','display:block')
            let listTarget = display.querySelector('#created-list')

            let frag = document.createDocumentFragment();

            state.tokenForm.createdTokens.forEach((token)=>{
                let listItem = document.createElement('li')
                listItem.appendChild(document.createTextNode(token.token+', '+token.package))
                frag.appendChild(listItem)
            })

            listTarget.innerHTML = ""
            listTarget.appendChild(frag)
        }

        function qs(str){
            let params = {}
            str.split('&').forEach((kv)=>{
                let parts = kv.split('=')
                params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1])
            })
            return params;
        }

        loop()
        </script>
    </body>
</html>