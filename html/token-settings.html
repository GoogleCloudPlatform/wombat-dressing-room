<!DOCTYPE html>
<html>
    <head>
        <title>Wombat dressing room: token settings</title>
        <link href="/app.css" rel="StyleSheet"/>
    </head>
    <body>
        <article class="markdown-body">
            <style>
            .errored {
                border:1px solid red;
            }
            </style>
            <h1>Choose a token type</h1>
            <div>
                <h3>24 hour publish token</h3>
                <div>If you are publishing from your workstation, or running the npm cli directly, this is likely the best option.</div>
                <form id="ttl-token" action="/_/token">
                    <input type="hidden" value="ttl" name="type"/>
                    <input class="ott" type="hidden" name="ott" value=""/>
                    <button>Create 24 hour token</button>
                </form>
            </div>
            <div>
                <h3>Release-backed token</h3>
                <div>A publication will only be permitted if a corresponding release is found on GitHub.</div>
                <form id="release-token" action="/_/token">
                    <input type="hidden" value="release" name="type"/>
                    <input class="ott" type="hidden" name="ott" value=""/>
                    <button>Create release-backed publication token</button>
                </form>
            </div>
            <div>
                <h3>Package specific publish token.</h3>
                <div>Package tokens do not timeout, but can only publish a single package. Use these for build automation, etc.</div>
                <form id="settings" action="/_/token">
                    <label for="package">Which npm package can this token publish?</label><br/>
                    <input class="ott" type="hidden" name="ott" value=""/>
                    <input id="package-name-input" type="text" name="package" placeholder="full package name here" value="" autocomplete="off" /><br/>
                    <button>Create</button>
                </form>
            </div>
            <script>
            let query = {}
            ;(window.location.search||'?').substr(1).split('&').forEach((kv)=>{
                kv = kv.split('=')
                query[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1]||'')
            })
            
            if(query.ott) {
                document.querySelectorAll('.ott').forEach((el)=>{
                    el.value = query.ott
                })
            } else {
                console.log('error. ott not found.')
            }

            const settings = document.getElementById('settings')
            const packageInput = document.querySelector('input[name=package]')
            settings.addEventListener('submit',(ev)=>{
                let pkg = packageInput.value
                if(!pkg.length) {
                    ev.preventDefault();
                    ev.stopImmediatePropagation();
                    packageInput.setAttribute('class','errored')
                    setTimeout(()=>{
                        packageInput.setAttribute('class','')
                    },1000)
                    return;
                }
            })

            if(query.package){
                packageInput.value = decodeURIComponent(query.package)
            }
            </script>
        </article>
    </body>
</html>
